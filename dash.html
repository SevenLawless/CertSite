<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R2PKC531LB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-R2PKC531LB');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background-color: #f5f5f5;
            padding-top: 20px;
        }
        .dashboard-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stats-card {
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stats-card h3 {
            color: #188995;
            margin-bottom: 5px;
        }
        .stats-value {
            font-size: 36px;
            font-weight: bold;
            color: #065e69;
        }
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stats-row .stats-card {
            flex: 1;
        }
        h1, h2 {
            color: #188995;
            margin-bottom: 20px;
            text-align: center;
        }
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .login-btn {
            background-color: #188995;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .login-btn:hover {
            background-color: #0e6b76;
        }
        .ga-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #4285F4;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .ga-link:hover {
            background-color: #2b6bc3;
        }
        .error-message {
            color: #e74c3c;
            margin: 10px 0;
            display: none;
        }
        .date-range {
            margin: 20px 0;
            text-align: center;
        }
        .date-range select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 30px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="loginSection" class="login-container">
        <h1>Login</h1>
        <p>Please enter the password to access the dashboard</p>
        <input type="password" id="passwordInput" class="password-input" placeholder="Password">
        <div id="errorMessage" class="error-message">Incorrect password</div>
        <button id="loginButton" class="login-btn">Login</button>
    </div>

    <div id="dashboardPanel" class="dashboard-container" style="display:none">
        <h1>Analytics Dashboard</h1>
        
        <div class="date-range">
            <label for="dateRange">Display data from: </label>
            <select id="dateRange">
                <option value="30">Last 30 days</option>
                <option value="90">Last 3 months</option>
                <option value="180">Last 6 months</option>
                <option value="365">Last year</option>
                <option value="0" selected>Since beginning</option>
            </select>
        </div>
        
        <div id="statsSection">
            <div class="loading">Loading data...</div>
        </div>
        
        <a href="https://analytics.google.com/" target="_blank" class="ga-link">
            Open Google Analytics in new window
        </a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginSection = document.getElementById('loginSection');
            const dashboardPanel = document.getElementById('dashboardPanel');
            const passwordInput = document.getElementById('passwordInput');
            const loginButton = document.getElementById('loginButton');
            const errorMessage = document.getElementById('errorMessage');
            const dateRange = document.getElementById('dateRange');
            const statsSection = document.getElementById('statsSection');
            
            // Simple hash of your password (replace with your own hash)
            // Current password: admin123
            const correctPasswordHash = "f865b53623b121fd34ee5426c792e5c33af8c227";
            
            // Function to hash password
            async function hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-1', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            }
            
            // Login function
            loginButton.addEventListener('click', async () => {
                const passwordHash = await hashPassword(passwordInput.value);
                
                if (passwordHash === correctPasswordHash) {
                    loginSection.style.display = 'none';
                    dashboardPanel.style.display = 'block';
                    loadDashboardData();
                } else {
                    errorMessage.style.display = 'block';
                    passwordInput.value = '';
                }
            });
            
            // Allow pressing Enter to login
            passwordInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    loginButton.click();
                }
            });
            
            // Load dashboard data when date range changes
            dateRange.addEventListener('change', loadDashboardData);
            
            // Function to load dashboard data
            function loadDashboardData() {
                statsSection.innerHTML = '<div class="loading">Loading data...</div>';
                
                // Try to use the Google Analytics API
                try {
                    // Add Google Analytics API script
                    if (!document.getElementById('ga-api-script')) {
                        const script = document.createElement('script');
                        script.id = 'ga-api-script';
                        script.src = 'https://apis.google.com/js/api.js';
                        script.onload = () => {
                            // Initialize the API client
                            gapi.load('client:auth2', initAnalytics);
                        };
                        script.onerror = () => {
                            // If script fails to load, fall back to demo data
                            console.error('Failed to load Google API script');
                            fallbackToDemoData("Failed to load Google API library");
                        };
                        document.head.appendChild(script);
                    } else {
                        // If script already loaded, just initialize analytics
                        if (typeof gapi !== 'undefined') {
                            gapi.load('client:auth2', initAnalytics);
                        } else {
                            fallbackToDemoData("Failed to load Google API");
                        }
                    }
                } catch (error) {
                    // Catch any unexpected errors and fall back to demo data
                    console.error('Error initializing API:', error);
                    fallbackToDemoData("Unexpected error occurred");
                }
            }
            
            // Fallback to demo data with a warning
            function fallbackToDemoData(reason) {
                console.warn(`Falling back to demo data. Reason: ${reason}`);
                // Show demo data with a short timeout to simulate API call
                setTimeout(() => {
                    const simulatedData = getDemoData();
                    displayStats(simulatedData);
                }, 500);
            }
            
            // Initialize Google Analytics API
            function initAnalytics() {
                // Your actual API credentials
                const apiKey = 'AIzaSyC1jYwQblxrI45j3BKtJbjaxGxjmIiHiKY';
                const clientId = '784216188240-vcqe7fi7dcjg6auuibh975r0rkis80mp.apps.googleusercontent.com';
                const propertyId = '483251561';
                
                // Check if we're on localhost/development environment
                const isLocalhost = window.location.hostname === 'localhost' || 
                                   window.location.hostname === '127.0.0.1';
                
                if (isLocalhost) {
                    console.warn('Running on localhost - Google Analytics API requires registered origins');
                    const localhostMessage = `
                        <div class="stats-card" style="background-color: #f8d7da; border-right: 4px solid #dc3545; margin-bottom: 20px;">
                            <h3 style="color: #721c24;">Local Development Environment Detected</h3>
                            <p>You're running this dashboard on localhost (${window.location.origin}), but this origin is not registered in your Google Cloud Console.</p>
                            <p style="margin-top: 15px;"><strong>To fix this:</strong></p>
                            <ol style="text-align: left; padding-left: 20px;">
                                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console Credentials</a></li>
                                <li>Find and edit your OAuth 2.0 Client ID</li>
                                <li>Add "${window.location.origin}" as an "Authorized JavaScript origin"</li>
                                <li>Save and wait a few minutes for the changes to propagate</li>
                                <li>Refresh this page</li>
                            </ol>
                            <p style="margin-top: 15px;">Or upload this dashboard to your actual website where it will work correctly.</p>
                        </div>
                        <div class="stats-card">
                            <h3>Showing Demo Data</h3>
                            <p>The dashboard is showing demo data for now. Real data will appear when correctly set up.</p>
                        </div>
                    `;
                    statsSection.innerHTML = localhostMessage;
                    
                    // Also show sample data below the warning
                    setTimeout(() => {
                        const simulatedData = getDemoData();
                        displayStats(simulatedData);
                    }, 500);
                    
                    return;
                }
                
                gapi.client.init({
                    apiKey: apiKey,
                    clientId: clientId,
                    discoveryDocs: ['https://analyticsdata.googleapis.com/$discovery/rest?version=v1beta'],
                    scope: 'https://www.googleapis.com/auth/analytics.readonly'
                }).then(() => {
                    // Check if user is signed in
                    if (!gapi.auth2.getAuthInstance().isSignedIn.get()) {
                        // If not signed in, show login button
                        statsSection.innerHTML = `
                            <div class="stats-card">
                                <h3>Sign in to Google Analytics</h3>
                                <p>You need to sign in with a Google account that has access to your website analytics</p>
                                <button id="ga-login" class="login-btn" style="max-width: 300px; margin: 20px auto;">Sign in with Google</button>
                            </div>
                        `;
                        
                        document.getElementById('ga-login').addEventListener('click', () => {
                            gapi.auth2.getAuthInstance().signIn().catch(error => {
                                console.error('Sign-in error:', error);
                                fallbackToDemoData("Google sign-in failed");
                            });
                        });
                        
                        // Add listener for sign-in state changes
                        gapi.auth2.getAuthInstance().isSignedIn.listen(signInChanged);
                    } else {
                        // Already signed in, fetch data
                        fetchAnalyticsData();
                    }
                }).catch(error => {
                    console.error('Error initializing analytics:', error);
                    
                    // Show a more helpful error message based on the error
                    let errorMessage = "Error initializing Google Analytics";
                    let helpText = "";
                    
                    if (error.details && error.details.includes("Not a valid origin")) {
                        errorMessage = "Domain Not Authorized";
                        helpText = `
                            <p>Your website domain (${window.location.origin}) needs to be added as an authorized domain in Google Cloud Console.</p>
                            <ol style="text-align: left; padding-left: 20px;">
                                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console Credentials</a></li>
                                <li>Find and edit your OAuth 2.0 Client ID</li>
                                <li>Add "${window.location.origin}" as an "Authorized JavaScript origin"</li>
                                <li>Save and wait a few minutes for the changes to propagate</li>
                            </ol>
                        `;
                    } else if (error.details && error.details.includes("API key not valid")) {
                        errorMessage = "API Key Issue";
                        helpText = `
                            <p>There's a problem with your Google API key. It might be invalid or missing required permissions.</p>
                            <ol style="text-align: left; padding-left: 20px;">
                                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console Credentials</a></li>
                                <li>Check that your API key exists and is active</li>
                                <li>Make sure the Google Analytics Data API is enabled for your project</li>
                                <li>Check if there are any API restrictions that might be blocking access</li>
                            </ol>
                        `;
                    } else if (error.status === 403 || (error.result && error.result.error && error.result.error.status === "PERMISSION_DENIED")) {
                        errorMessage = "Permission Denied";
                        helpText = `
                            <p>Your account doesn't have permission to access this Google Analytics property.</p>
                            <ol style="text-align: left; padding-left: 20px;">
                                <li>Make sure you're signing in with the correct Google account that has access to this GA property</li>
                                <li>Check that the property ID (${propertyId}) is correct</li>
                                <li>Verify that your account has at least Viewer access to this GA property</li>
                            </ol>
                        `;
                    }
                    
                    statsSection.innerHTML = `
                        <div class="stats-card" style="background-color: #f8d7da; border-right: 4px solid #dc3545; margin-bottom: 20px;">
                            <h3 style="color: #721c24;">${errorMessage}</h3>
                            <p>${error.details || error.message || "Unknown error"}</p>
                            ${helpText}
                        </div>
                    `;
                    
                    fallbackToDemoData("Error initializing Google Analytics: " + (error.details || error.message || "Unknown error"));
                });
            }
            
            // Handle sign-in state changes
            function signInChanged(isSignedIn) {
                if (isSignedIn) {
                    fetchAnalyticsData();
                }
            }
            
            // Fetch analytics data from Google Analytics API
            function fetchAnalyticsData() {
                const propertyId = '483251561';
                
                const selectedRange = dateRange.value;
                const today = new Date();
                let startDate = new Date();
                
                if (selectedRange === "0") {
                    // Start from the beginning (1 year ago as default)
                    startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                } else {
                    // Start from specified days ago
                    startDate = new Date(today.getTime() - parseInt(selectedRange) * 24 * 60 * 60 * 1000);
                }
                
                const dateRanges = [{
                    startDate: `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`,
                    endDate: `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`
                }];
                
                // Prepare requests for different metrics
                const requests = [
                    // Visitors (users and new users)
                    {
                        dimensions: [{ name: "country" }],
                        metrics: [
                            { name: "totalUsers" },
                            { name: "newUsers" }
                        ],
                        dateRanges: dateRanges
                    },
                    // Device types
                    {
                        dimensions: [{ name: "deviceCategory" }],
                        metrics: [{ name: "totalUsers" }],
                        dateRanges: dateRanges
                    },
                    // Event counts for certificate generation and downloads
                    {
                        dimensions: [{ name: "eventName" }],
                        metrics: [{ name: "eventCount" }],
                        dimensionFilter: {
                            filter: {
                                fieldName: "eventName",
                                inListFilter: {
                                    values: ["generate_certificate", "download_certificate"]
                                }
                            }
                        },
                        dateRanges: dateRanges
                    }
                ];
                
                // Function to execute each request
                const executeRequest = (request) => {
                    return gapi.client.analyticsdata.properties.runReport({
                        property: `properties/${propertyId}`,
                        ...request
                    });
                };
                
                // Execute all requests in parallel
                Promise.all(requests.map(executeRequest))
                    .then(responses => {
                        // Process the responses
                        const data = processAnalyticsResponses(responses, dateRanges[0]);
                        displayStats(data);
                    })
                    .catch(error => {
                        console.error('Error fetching analytics data:', error);
                        fallbackToDemoData("Error fetching data from Google Analytics");
                    });
            }
            
            // Process responses from Analytics API
            function processAnalyticsResponses(responses, dateRange) {
                // Format dates for display
                const formattedStartDate = new Date(dateRange.startDate).toLocaleDateString();
                const formattedEndDate = new Date(dateRange.endDate).toLocaleDateString();
                
                // Extract data from responses
                const [usersResponse, deviceResponse, eventsResponse] = responses;
                
                // Prepare result object
                const result = {
                    dateRange: `${formattedStartDate} - ${formattedEndDate}`,
                    totalVisitors: 0,
                    uniqueVisitors: 0,
                    certificatesGenerated: 0,
                    certificatesDownloaded: 0,
                    mobileUsers: 0,
                    desktopUsers: 0,
                    topCountries: []
                };
                
                // Extract visitor data
                if (usersResponse && usersResponse.result && usersResponse.result.rows) {
                    // Sum total and unique users
                    usersResponse.result.rows.forEach(row => {
                        result.totalVisitors += parseInt(row.metricValues[0].value || 0);
                        result.uniqueVisitors += parseInt(row.metricValues[1].value || 0);
                        
                        // Add to top countries
                        if (row.dimensionValues[0].value !== '(not set)') {
                            result.topCountries.push({
                                name: row.dimensionValues[0].value,
                                count: parseInt(row.metricValues[0].value || 0)
                            });
                        }
                    });
                    
                    // Sort and limit top countries
                    result.topCountries.sort((a, b) => b.count - a.count);
                    result.topCountries = result.topCountries.slice(0, 5);
                }
                
                // Extract device data
                if (deviceResponse && deviceResponse.result && deviceResponse.result.rows) {
                    deviceResponse.result.rows.forEach(row => {
                        const deviceType = row.dimensionValues[0].value;
                        const count = parseInt(row.metricValues[0].value || 0);
                        
                        if (deviceType === 'mobile') {
                            result.mobileUsers += count;
                        } else if (deviceType === 'desktop') {
                            result.desktopUsers += count;
                        } else if (deviceType === 'tablet') {
                            // Add tablet users to mobile for simplicity
                            result.mobileUsers += count;
                        }
                    });
                }
                
                // Extract event data
                if (eventsResponse && eventsResponse.result && eventsResponse.result.rows) {
                    eventsResponse.result.rows.forEach(row => {
                        const eventName = row.dimensionValues[0].value;
                        const count = parseInt(row.metricValues[0].value || 0);
                        
                        if (eventName === 'generate_certificate') {
                            result.certificatesGenerated = count;
                        } else if (eventName === 'download_certificate') {
                            result.certificatesDownloaded = count;
                        }
                    });
                }
                
                return result;
            }
            
            // Function to get demonstration data - used as fallback if API fails
            function getDemoData() {
                // This is used as fallback if Google Analytics API fails
                const selectedRange = dateRange.value;
                const today = new Date();
                let startDate = new Date();
                
                if (selectedRange === "0") {
                    // Start from the beginning (simulated to be about a year ago)
                    startDate = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                } else {
                    // Start from specified days ago
                    startDate = new Date(today.getTime() - parseInt(selectedRange) * 24 * 60 * 60 * 1000);
                }
                
                // Format dates for display
                const formattedStartDate = startDate.toLocaleDateString();
                const formattedEndDate = today.toLocaleDateString();
                
                return {
                    dateRange: `${formattedStartDate} - ${formattedEndDate}`,
                    totalVisitors: Math.floor(Math.random() * 5000) + 500,
                    uniqueVisitors: Math.floor(Math.random() * 3000) + 300,
                    certificatesGenerated: Math.floor(Math.random() * 1000) + 100,
                    certificatesDownloaded: Math.floor(Math.random() * 800) + 80,
                    topCountries: [
                        {name: "Saudi Arabia", count: Math.floor(Math.random() * 1000) + 100},
                        {name: "Egypt", count: Math.floor(Math.random() * 800) + 50},
                        {name: "United Arab Emirates", count: Math.floor(Math.random() * 600) + 30},
                        {name: "Kuwait", count: Math.floor(Math.random() * 400) + 20},
                        {name: "Qatar", count: Math.floor(Math.random() * 200) + 10}
                    ],
                    mobileUsers: Math.floor(Math.random() * 3000) + 200,
                    desktopUsers: Math.floor(Math.random() * 2000) + 300,
                    isDemo: true // Flag to indicate this is demo data
                };
            }
            
            // Function to display stats
            function displayStats(data) {
                // Add a warning if using demo data
                const dataSourceInfo = data.isDemo 
                    ? `<div class="stats-card" style="background-color: #fff3cd; border-right: 4px solid #ffc107; margin-bottom: 20px;">
                        <h3 style="color: #856404;">Warning: Demo Data</h3>
                        <p>These are randomly generated numbers for display purposes only. To view real data, you need to set up Google Analytics connection properly.</p>
                      </div>`
                    : '';
                
                let html = `
                    ${dataSourceInfo}
                    <h2>Website Statistics (${data.dateRange})</h2>
                    
                    <div class="stats-row">
                        <div class="stats-card">
                            <h3>Total Visits</h3>
                            <div class="stats-value">${data.totalVisitors}</div>
                        </div>
                        <div class="stats-card">
                            <h3>Unique Visitors</h3>
                            <div class="stats-value">${data.uniqueVisitors}</div>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <div class="stats-card">
                            <h3>Certificates Generated</h3>
                            <div class="stats-value">${data.certificatesGenerated}</div>
                        </div>
                        <div class="stats-card">
                            <h3>Certificates Downloaded</h3>
                            <div class="stats-value">${data.certificatesDownloaded}</div>
                        </div>
                    </div>
                    
                    <div class="stats-row">
                        <div class="stats-card">
                            <h3>Mobile Users</h3>
                            <div class="stats-value">${data.mobileUsers}</div>
                        </div>
                        <div class="stats-card">
                            <h3>Desktop Users</h3>
                            <div class="stats-value">${data.desktopUsers}</div>
                        </div>
                    </div>
                    
                    <div class="stats-card">
                        <h3>Top Countries</h3>
                        <ul style="list-style: none; padding: 0;">
                `;
                
                if (data.topCountries && data.topCountries.length > 0) {
                    data.topCountries.forEach(country => {
                        html += `<li style="padding: 5px 0;"><strong>${country.name}</strong>: ${country.count} visits</li>`;
                    });
                } else {
                    html += `<li style="padding: 5px 0;">No country data available</li>`;
                }
                
                html += `
                        </ul>
                    </div>
                `;
                
                // Add setup instructions if using demo data
                if (data.isDemo) {
                    html += `
                    <div style="margin-top: 30px; text-align: left; padding: 15px; background-color: #f8f8f8; border-radius: 8px;">
                        <h3 style="color: #188995;">How to Set Up Real Analytics</h3>
                        <ol style="text-align: left; padding-left: 20px;">
                            <li>Log in to your <a href="https://analytics.google.com/" target="_blank">Google Analytics</a> account</li>
                            <li>Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a> and create a new project</li>
                            <li>Enable the Google Analytics API from the API Library</li>
                            <li>Create OAuth credentials and get a Client ID</li>
                            <li>Create an API Key</li>
                            <li>Replace the API credentials in the dash.html file with your own</li>
                        </ol>
                    </div>`;
                }
                
                statsSection.innerHTML = html;
            }
        });
    </script>
</body>
</html> 